#!/bin/bash
I3_HOME=${I3_HOME:-~/.i3}
I3_THEMEDIR=${I3_THEMEDIR:-$I3_HOME/themes}
themes=()
for t in $I3_THEMEDIR/*; do
    [[ -r $t/i3.m4 ]] || continue
    themes+=(${t##*/})
done
theme=$(printf '%s\n' "${themes[@]}" | dmenu ${1+"$@"}) || exit 1

m4 $I3_M4_THEMEARGS -I$I3_HOME -I$I3_THEMEDIR/$theme $I3_HOME/config.m4 > $I3_HOME/config
m4 $I3_M4_THEMEARGS -I$I3_HOME -I$I3_THEMEDIR/$theme $I3_HOME/Xresources.m4 > $I3_HOME/Xresources

# Run any pre-processing scripts (if applicable)
for script in $I3_THEMEDIR/$theme/run.d/*; do
    [[ -x $script ]] && $script &>/dev/null
done

# Update vim theme (if applicable)
if [[ -r ~/.vim/theme.m4 ]] && [[ -d ~/.vim/themes/$theme ]]; then
    m4 -I$HOME/.vim -I$HOME/.vim/themes/$theme ~/.vim/theme.m4 > ~/.vim/theme
fi

i3-msg restart

